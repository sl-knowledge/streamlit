<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        :root {
            --tasmania-green: #00843D;
            --tasmania-blue: #003F87;
            --tasmania-yellow: #FFCD00;
            --tasmania-red: #C8102E;
            --text-color: #333;
            --background-color: #E6F3FF;
            --card-background: #FFFFFF;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            background-image: url('https://images.unsplash.com/photo-1572907572679-54ff8d9d6996?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-attachment: fixed;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: var(--tasmania-blue);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }
        h2 {
            font-size: 1.5em; /* Adjust this value as needed */
            color: #cc520b; /* Optional: change the color for better distinction */
            margin-top: 1.5em; /* Add some space above the heading */
            margin-bottom: 0.5em; /* Add some space below the heading */
            border-bottom: 2px solid var(--tasmania-green);
            padding-bottom: 10px;
            font-weight: 400;
        }

            /* Style for text below second-level headings */
        h2 + p,
        h2 + ul,
        h2 + ol {
            font-size: 1em; /* Adjust this value to make text smaller or larger */
            line-height: 1.5; /* Adjust line height for readability */
        }
        .section {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            overflow: hidden;
            transition: box-shadow 0.3s ease;
            position: relative; /* Add this */
            padding-bottom: 50px; /* Add this to make room for buttons */
        }
        .section:hover {
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .section-content {
            padding: 20px;
        }
        .button-container {
            background-color: #f8f9fa;
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #e9ecef;
            position: absolute; /* Add this */
            bottom: 0; /* Add this */
            left: 0; /* Add this */
            right: 0; /* Add this */
        }
        button {
            background-color: var(--tasmania-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            margin-left: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-button.saved {
            background-color: var(--tasmania-green);
        }
        .voice-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .saved-content {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .floating-button {
            position: fixed;
            bottom: 5px;
            left: 20px; /* Changed from right: 20px to left: 20px */
            padding: 10px 20px;
            background-color: #00843D;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
        }
        .hidden {
            display: none;
        }
        .video-container {
            width: 100%;
            max-width: 640px;
            margin: 0 auto 30px;
            text-align: center;
        }

        .video-thumbnail {
            position: relative;
            width: 100%;
            cursor: pointer;
            display: inline-block;
            overflow: hidden;
            border-radius: 8px;
        }

        .video-thumbnail img {
            width: 100%;
            height: auto;
            transition: filter 0.3s ease;
        }

        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 68px;
            height: 48px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .play-button::after {
            content: '';
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 0 10px 20px;
            border-color: transparent transparent transparent white;
            margin-left: 4px;
        }

        .video-thumbnail:hover img {
            filter: brightness(0.8);
        }

        .video-thumbnail:hover .play-button {
            background-color: #ff0000;
        }

        .video-container iframe {
            width: 100%;
            height: 360px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .floating-video {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px; /* Same as container max-width */
            height: 450px; /* Default height for larger screens */
            max-height: 56.25vw; /* 16:9 aspect ratio, will adjust for smaller screens */
            z-index: 9999;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            background: black;
        }
        .floating-video iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .close-video {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        @media (max-width: 820px) { /* Adjusted for container padding */
            .floating-video {
                width: calc(100% - 40px); /* Accounting for container padding */
            }
        }
        
        .content-block {
            margin-bottom: 10px;
        }
        
        .content-block h2 {
            font-size: 1.5em;
            color: #cc520b;
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        
        /* Remove these rules that were adding the triangles */
        /*
        .content-block h2::after {
            content: ' ▼';
            float: right;
        }
        
        .content-block h2.expanded::after {
            content: ' ▲';
        }
        */
        
        .content-block .content {
            display: none;
            padding: 10px;
            border: 1px solid #f0f0f0;
        }

        .font-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
            z-index: 1000;
        }

        .font-controls button {
            margin: 0 5px;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
        }

        /* Add this new rule */
        body, .section-content, .content {
            transition: font-size 0.3s ease;
        }

        .speed-control {
            position: fixed;
            bottom: 10px;
            right: 30px; /* Changed from 10px to 20px to move it left */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            width: auto;
            max-width: 100%;
        }

        #speed-slider {
            width: 200px;
            margin: 0 8px 0 0;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #speed-slider:hover {
            opacity: 1;
        }

        #speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }

        #speed-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }

        #speed-value {
            min-width: 36px;
            text-align: right;
            font-size: 14px;
        }

        /* Media query for smaller screens */
        @media (max-width: 600px) {
            .speed-control {
                padding: 6px 10px;
                right: 10px; /* Adjust for smaller screens */
                bottom: 5px;
            }

            #speed-slider {
                width: 150px; /* Increased from 70px to 150px for mobile */
            }

            #speed-value {
                min-width: 30px;
                font-size: 12px;
            }
        }

        #scroll-to-top {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            border: none;
            outline: none;
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--tasmania-blue);
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #scroll-to-top:hover {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--tasmania-green);
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #scroll-to-top::before {
            content: "↑ Top";
            display: inline-block;
            transition: transform 0.3s ease;
        }

        #scroll-to-top:hover::before {
            transform: translateY(-2px);
        }

        .speak-on-click {
            margin-bottom: 20px;
            text-align: center;
        }

        #speak-on-click-toggle {
            margin-left: 10px;
        }
        .translation-wrapper {
            position: relative;
            cursor: pointer;
            line-height: 1.6;
            padding: 5px 0;
        }
        .translated-word {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .translated-word:hover {
            background-color: #ffff99; /* Light yellow highlight */
        }
        .translated-word:hover::after {
            content: attr(data-translation);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .chinese-word {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .chinese-word:hover {
            background-color: #ffff99; /* Light yellow highlight */
        }
        .chinese-word:hover::after {
            content: attr(data-translation);
            position: absolute;
            top: 100%; /* Change from bottom: 100% to top: 100% */
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .chinese-word .pinyin {
            position: absolute;
            bottom: 100%; /* Change from top: -1.5em to bottom: 100% */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #666;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* Prevent pinyin from interfering with hover */
        }

        .chinese-word:hover .pinyin {
            opacity: 1;
        }

        /* Remove the .highlighted class styles */

        .section-index {
            color: #888;
            font-weight: normal;
            margin-right: 0.5em;
        }

        .lock-button {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 5px 10px;
            margin-left: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block; /* Ensure the button is displayed */
        }

        .lock-button.locked {
            background-color: #4CAF50;
            color: white;
        }

        .chinese-word.highlighted {
            background-color: #ffff99;
        }

        .button-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .cloze-container {
            display: inline-block;
        }

        .cloze {
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
        }

        .cloze-answer {
            color: #4a4a4a;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ title }}</h1>
        <div class="voice-selector">
            <label for="voice-select">Select Voice: </label>
            <select id="voice-select"></select>
        </div>
        <div class="speak-on-click">
            <label for="speak-on-click-toggle">Speak word on click: </label>
            <input type="checkbox" id="speak-on-click-toggle" checked>
        </div>
        <div class="speed-control">
            <input type="range" id="speed-slider" min="0" max="1.5" step="0.1" value="1">
            <span id="speed-value">1.0x</span>
        </div>

        <!-- Video container -->
        <div class="video-container">
            <div class="video-thumbnail" onclick="loadVideo(this)">
                <img src="https://img.youtube.com/vi/{{ video_id }}/maxresdefault.jpg" alt="{{ title }}">
                <div class="play-button"></div>
            </div>
        </div>

        <div id="content">
            {{ content }}
        </div>
        <div class="saved-content" id="saved-content">
            <h3>Saved Content</h3>
            <div id="saved-blocks"></div>
        </div>
    </div>

    <button id="toggle-view" class="floating-button">Show Saved</button>

    <div class="font-controls">
        <button onclick="changeFontSize(1)">A+</button>
        <button onclick="changeFontSize(-1)">A-</button>
        <button onclick="resetFontSize()">Reset</button>
    </div>

    <script>
        console.log('JavaScript file loaded');

        let selectedVoice = null;
        let isReading = false;
        let currentUtterance = null;
        let isPaused = false;
        let currentText = '';
        let currentPosition = 0;
        let currentFontSize = 16; // Default font size in pixels
        const minFontSize = 12;
        const maxFontSize = 24;
        let speakingRate = 1.0;
        let speakOnClick = true;
        let isSpeaking = false;
        let clickCount = 0;

        function getStorageKey() {
            return `savedSections_${encodeURIComponent("{{ title }}")}`;
        }

        function initVoiceSelection() {
            const voiceSelect = document.getElementById('voice-select');
            const preferredVoiceName = "Microsoft Xiaoxiao Online (Natural) - Chinese (Mainland)";
            
            function loadVoices() {
                const voices = speechSynthesis.getVoices();
                selectedVoice = null;

                // Clear existing options
                voiceSelect.innerHTML = '';

                let defaultVoice = null;
                let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                let isAndroid = /Android/.test(navigator.userAgent);

                // Filter and add voices based on the platform
                voices.filter(voice => voice.lang.startsWith('zh'))
                      .forEach(voice => {
                          const option = document.createElement('option');
                          option.value = voice.name;
                          option.textContent = `${voice.name} (${voice.lang})`;
                          
                          if (isIOS) {
                              // For iOS, include all voices but prefer Lilian
                              voiceSelect.appendChild(option);
                              if (voice.name.includes('Lilian')) {
                                  defaultVoice = voice;
                              }
                          } else if (isAndroid) {
                              // For Android, include enhanced and premium voices
                              if (voice.name.includes('Enhanced') || voice.name.includes('Premium')) {
                                  voiceSelect.appendChild(option);
                                  if (!defaultVoice) {
                                      defaultVoice = voice;
                                  }
                              }
                          } else {
                              // For PC, keep the current setting
                              voiceSelect.appendChild(option);
                              if (voice.name === preferredVoiceName) {
                                  defaultVoice = voice;
                              }
                          }
                      });

                // Fallback logic if no preferred voice is found
                if (!defaultVoice) {
                    if (isIOS) {
                        defaultVoice = voices.find(voice => voice.lang.startsWith('zh') && voice.name.includes('Lilian'));
                    } else if (isAndroid) {
                        defaultVoice = voices.find(voice => voice.lang.startsWith('zh') && (voice.name.includes('Enhanced') || voice.name.includes('Premium')));
                    } else {
                        defaultVoice = voices.find(voice => 
                            voice.name.toLowerCase().includes('xiaoxiao') &&
                            voice.lang.startsWith('zh')
                        ) || voices.find(voice => 
                            voice.lang.startsWith('zh') && 
                            !voice.localService && 
                            voice.name.toLowerCase().includes('natural')
                        );
                    }
                }

                // Set the default voice if found
                if (defaultVoice) {
                    voiceSelect.value = defaultVoice.name;
                    selectedVoice = defaultVoice;
                } else if (voiceSelect.options.length > 0) {
                    // If no suitable default voice is found, select the first available Chinese voice
                    voiceSelect.selectedIndex = 0;
                    selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
                }

                updateSelectedVoice();
            }

            function updateSelectedVoice() {
                const voices = speechSynthesis.getVoices();
                selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
            }

            speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();

            voiceSelect.addEventListener('change', updateSelectedVoice);

            // Add event listener for speed slider
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            
            speedSlider.addEventListener('input', function() {
                speakingRate = parseFloat(this.value);
                // Ensure the rate is never 0, set a minimum of 0.1
                speakingRate = Math.max(0.1, speakingRate);
                speedValue.textContent = speakingRate.toFixed(1) + 'x';
                if (isReading && !isPaused) {
                    updateSpeakingRate();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            
            // Debug code for lock buttons
            const lockButtons = document.querySelectorAll('.lock-button');
            console.log('Number of lock buttons:', lockButtons.length);
            lockButtons.forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Lock button clicked');
                });
            });

            // Debug code for Chinese words
            const chineseWords = document.querySelectorAll('.chinese-word');
            console.log('Number of Chinese words:', chineseWords.length);
            chineseWords.forEach(word => {
                word.addEventListener('click', function() {
                    console.log('Chinese word clicked');
                });
            });

            // Remove existing click listeners from all Chinese words
            document.querySelectorAll('.chinese-word').forEach(function(word) {
                word.removeEventListener('click', speakWord);
            });

            console.log('Removing existing click listener from body (if any)');
            document.body.removeEventListener('click', handleWordClick);

            console.log('Adding click listener to document.body');
            document.body.addEventListener('click', handleBodyClick);

            console.log('Initial speakOnClick value:', speakOnClick);

            const content = document.getElementById('content');
            const sections = content.innerHTML.split('<h2>');
            
            content.innerHTML = sections.map((section, index) => {
                if (index === 0) return section;
                const sectionId = `section-${index}`;
                return `
                    <div class="section" id="${sectionId}">
                        <div class="section-content">
                            <div class="content-block">
                                <h2>${section.split('</h2>')[0]}</h2>
                                <div class="content">
                                    ${section.split('</h2>')[1] || ''}
                                </div>
                            </div>
                        </div>
                        <div class="button-container">
                            <button class="read-button" onclick="toggleReading('${sectionId}', this)">Read</button>
                            <button class="save-button" onclick="toggleSaveSection('${sectionId}')">Save</button>
                            <button class="lock-button" onclick="toggleLock('${sectionId}', this)">Lock</button>
                        </div>
                    </div>
                `;
            }).join('');

            initVoiceSelection();
            loadSavedSections();
            makeContentExpandable();

            const toggleButton = document.getElementById('toggle-view');
            const savedContent = document.getElementById('saved-content');

            toggleButton.addEventListener('click', function() {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    savedContent.classList.add('hidden');
                    toggleButton.textContent = 'Show Saved';
                } else {
                    content.classList.add('hidden');
                    savedContent.classList.remove('hidden');
                    toggleButton.textContent = 'Show All';
                }
            });

            // Initially hide the saved content
            savedContent.classList.add('hidden');

            const storageKey = getStorageKey();
            const savedSections = JSON.parse(localStorage.getItem(storageKey)) || [];
            savedSections.forEach(sectionId => {
                const saveButton = document.querySelector(`#${sectionId} .save-button`);
                if (saveButton) {
                    saveButton.textContent = 'Unsave';
                    saveButton.classList.add('saved');
                }
            });

            loadFontSize();

            const speakOnClickToggle = document.getElementById('speak-on-click-toggle');
            speakOnClickToggle.addEventListener('change', function() {
                speakOnClick = this.checked;
                localStorage.setItem('speakOnClick', speakOnClick);
            });

            // Load saved preference or use default (true)
            speakOnClick = localStorage.getItem('speakOnClick') !== 'false';
            speakOnClickToggle.checked = speakOnClick;

            // Remove this event listener
            // [contentContainer, savedContentContainer].forEach(container => {
            //     container.addEventListener('click', handleWordClick);
            // });

            document.querySelectorAll('.chinese-word').forEach(function(word) {
                const pinyin = word.getAttribute('data-pinyin');
                const pinyinElement = document.createElement('span');
                pinyinElement.className = 'pinyin';
                pinyinElement.textContent = pinyin;
                word.appendChild(pinyinElement);
            });

            // Add a single click event listener to the document body
            document.body.addEventListener('click', handleWordClick);

            var wordByWordTranslation = {{ word_by_word_translation|tojson }};
            var generatePinyin = {{ generate_pinyin|tojson }};

            // Initial update of the selected voice
            updateSelectedVoice();

            // Remove any existing click listeners
            document.body.removeEventListener('click', handleWordClick);

            // Add the click listener
            document.body.addEventListener('click', handleWordClick);

            // Handle section index display
            document.querySelectorAll('.section-index').forEach(function(indexSpan) {
                const index = indexSpan.getAttribute('data-index');
                indexSpan.textContent = index;
            });

            loadWordStates();

            // Add this line to check if lock buttons are created
            console.log('Number of lock buttons:', document.querySelectorAll('.lock-button').length);

            document.querySelectorAll('.lock-button').forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Lock button clicked');
                });
            });
        });

        function speakWord(element) {
            const word = element.getAttribute('data-word');
            const pinyin = element.getAttribute('data-pinyin');
            console.log('Speaking:', word, pinyin);

            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'zh-CN';
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            utterance.rate = speakingRate;
            
            utterance.onend = function() {
                isSpeaking = false;
            };
            
            speechSynthesis.speak(utterance);
        }

        function handleWordClick(event) {
            if (isSpeaking) return;
            
            const wordElement = event.target.closest('.chinese-word');
            if (wordElement) {
                const section = wordElement.closest('.section');
                const lockButton = section.querySelector('.lock-button');
                
                if (lockButton.classList.contains('locked')) {
                    wordElement.classList.toggle('highlighted');
                    saveHighlightedWordData(section.id);
                    updateSavedSection(section.id);
                    console.log(`Word clicked: ${wordElement.getAttribute('data-word')}, Highlighted: ${wordElement.classList.contains('highlighted')}`);
                }
                
                if (speakOnClick) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    isSpeaking = true;
                    speakWord(wordElement);
                }
            }
        }

        function toggleReading(sectionId, button) {
            console.log(`toggleReading called for section: ${sectionId}`);
            console.log(`Current isReading state: ${isReading}`);
            console.log(`Button text: ${button.textContent}`);
            
            // Prevent rapid toggling
            if (button.disabled) {
                console.log('Button is disabled, ignoring click');
                return;
            }
            button.disabled = true;
            setTimeout(() => { 
                button.disabled = false;
                console.log('Button re-enabled');
            }, 300);

            const sectionContent = document.querySelector(`#${sectionId} .section-content`);
            console.log('Section content found:', !!sectionContent);
            
            if (!isReading) {
                console.log('Starting reading process');
                button.textContent = 'Stop';
                isReading = true;
                
                // Extract only Chinese characters and punctuation, excluding the section index
                let chineseText = '';
                sectionContent.querySelectorAll('.chinese-word').forEach(word => {
                    if (!word.closest('.section-index')) {
                        const originalWord = word.getAttribute('data-word');
                        const chineseOnly = originalWord.replace(/[^\u4e00-\u9fa5。，！？；：""''（）]/g, '');
                        console.log(`Original word: "${originalWord}", Chinese only: "${chineseOnly}"`);
                        chineseText += chineseOnly;
                    }
                });
                
                console.log('Full Chinese text to be read:', chineseText);
                
                currentUtterance = new SpeechSynthesisUtterance(chineseText);
                currentUtterance.lang = 'zh-CN';
                
                if (selectedVoice) {
                    console.log('Using voice:', selectedVoice.name);
                    currentUtterance.voice = selectedVoice;
                } else {
                    console.log('No specific voice selected, using default');
                }
                
                currentUtterance.rate = speakingRate;
                
                currentUtterance.onend = function() {
                    console.log('Speech ended');
                    button.textContent = 'Read';
                    isReading = false;
                };
                
                console.log('Starting speech');
                speechSynthesis.speak(currentUtterance);
            } else {
                console.log('Stopping reading');
                button.textContent = 'Read';
                isReading = false;
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
            }
        }

        document.body.addEventListener('click', function(event) {
            const readButton = event.target.closest('.read-button');
            if (readButton) {
                event.preventDefault();
                const sectionId = readButton.closest('.section').id;
                toggleReading(sectionId, readButton);
            } else {
                handleWordClick(event);
            }
        });

        function toggleSaveSection(sectionId) {
            const storageKey = getStorageKey();
            const savedSections = JSON.parse(localStorage.getItem(storageKey)) || [];
            const index = savedSections.indexOf(sectionId);
            const saveButtons = document.querySelectorAll(`#${sectionId} .save-button, #saved-${sectionId} .save-button`);
            
            if (index === -1) {
                savedSections.push(sectionId);
                saveButtons.forEach(button => {
                    button.textContent = 'Unsave';
                    button.classList.add('saved');
                });
                // Create or update the saved section with the latest highlighted word data
                updateSavedSection(sectionId);
            } else {
                savedSections.splice(index, 1);
                saveButtons.forEach(button => {
                    button.textContent = 'Save';
                    button.classList.remove('saved');
                });
                // Remove the saved section
                const savedSection = document.getElementById(`saved-${sectionId}`);
                if (savedSection) {
                    savedSection.remove();
                }
            }
            
            localStorage.setItem(storageKey, JSON.stringify(savedSections));
            loadSavedSections();
        }

        function loadSavedSections() {
            const storageKey = getStorageKey();
            const savedSections = JSON.parse(localStorage.getItem(storageKey)) || [];
            const savedBlocks = document.getElementById('saved-blocks');
            const toggleButton = document.getElementById('toggle-view');
            
            savedBlocks.innerHTML = '';
            
            if (savedSections.length > 0) {
                savedSections.forEach(sectionId => {
                    updateSavedSection(sectionId);
                });
                toggleButton.style.display = 'block';
                makeContentExpandable();
            } else {
                savedBlocks.innerHTML = '<p>No saved sections yet.</p>';
                toggleButton.style.display = 'none';
            }
        }

        function toggleSavedSectionContent(sectionId) {
            const content = document.querySelector(`#saved-${sectionId} .saved-section-content`);
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }

        function loadVideo(element) {
            var floatingDiv = document.createElement('div');
            floatingDiv.className = 'floating-video';
            
            var iframe = document.createElement('iframe');
            iframe.setAttribute('src', 'https://www.youtube.com/embed/{{ video_id }}?autoplay=1');
            iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
            iframe.setAttribute('allowfullscreen', '');
            
            floatingDiv.appendChild(iframe);
            
            var closeButton = document.createElement('div');
            closeButton.className = 'close-video';
            closeButton.innerHTML = '×';
            closeButton.onclick = function() {
                document.body.removeChild(floatingDiv);
                document.body.style.paddingTop = '0';
                window.removeEventListener('resize', adjustVideoSize);
            };
            floatingDiv.appendChild(closeButton);
            
            document.body.appendChild(floatingDiv);
            
            adjustVideoSize();
            window.addEventListener('resize', adjustVideoSize);
        }

        function adjustVideoSize() {
            var container = document.querySelector('.container');
            var video = document.querySelector('.floating-video');
            if (video && container) {
                var containerWidth = container.offsetWidth;
                var maxHeight = Math.min(450, window.innerWidth * 0.5625); // 16:9 aspect ratio, max 450px
                
                video.style.width = Math.min(containerWidth, 800) + 'px';
                video.style.height = maxHeight + 'px';
                
                document.body.style.paddingTop = video.offsetHeight + 'px';
            }
        }

        function makeContentExpandable() {
            document.querySelectorAll('.content-block h2').forEach(h2 => {
                // Remove existing event listeners to prevent duplicates
                h2.removeEventListener('click', toggleContentVisibility);
                // Add new event listener
                h2.addEventListener('click', toggleContentVisibility);
                
                // Initially hide the content
                const content = h2.nextElementSibling;
                if (content && content.classList.contains('content')) {
                    content.style.display = 'none';
                }
            });
        }

        function toggleContentVisibility(event) {
            const content = event.target.nextElementSibling;
            if (content && content.classList.contains('content')) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    event.target.classList.add('expanded');
                } else {
                    content.style.display = 'none';
                    event.target.classList.remove('expanded');
                }
            }
        }

        function changeFontSize(change) {
            currentFontSize = Math.min(Math.max(currentFontSize + change, minFontSize), maxFontSize);
            updateFontSize();
        }

        function resetFontSize() {
            currentFontSize = 16;
            updateFontSize();
        }

        function updateFontSize() {
            document.body.style.fontSize = `${currentFontSize}px`;
            document.querySelectorAll('.section-content, .content').forEach(el => {
                el.style.fontSize = `${currentFontSize}px`;
            });
            localStorage.setItem('fontSize', currentFontSize);
        }

        function loadFontSize() {
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                currentFontSize = parseInt(savedFontSize);
                updateFontSize();
            }
        }

        function updateSpeakingRate() {
            if (currentUtterance) {
                currentUtterance.rate = speakingRate;
            }
        }

        // Scroll to top functionality
        let scrollToTopBtn = document.createElement('button');
        scrollToTopBtn.setAttribute('id', 'scroll-to-top');
        scrollToTopBtn.setAttribute('title', 'Scroll to top');
        document.body.appendChild(scrollToTopBtn);

        // When the user scrolls down 20px from the top of the document, show the button
        window.onscroll = function() {scrollFunction()};

        function scrollFunction() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollToTopBtn.style.display = "block";
            } else {
                scrollToTopBtn.style.display = "none";
            }
        }

        // When the user clicks on the button, scroll to the top of the document
        scrollToTopBtn.addEventListener('click', function(){
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        });

        // If you have a toggle for speakOnClick, add this debug:
        function toggleSpeakOnClick() {
            speakOnClick = !speakOnClick;
            console.log('speakOnClick toggled to:', speakOnClick);
        }

        // This function should be called when the voices are loaded and when the dropdown selection changes
        function updateSelectedVoice() {
            const voiceSelect = document.getElementById('voice-select');
            const voices = speechSynthesis.getVoices();
            selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
        }

        // Make sure this is called when the voices are loaded
        speechSynthesis.onvoiceschanged = function() {
            updateSelectedVoice();
        };

        // Add this event listener to update the selected voice when the dropdown changes
        document.getElementById('voice-select').addEventListener('change', updateSelectedVoice);

        document.removeEventListener('click', handleBodyClick);
        document.addEventListener('click', handleBodyClick);

        function handleBodyClick(event) {
            const readButton = event.target.closest('.read-button');
            if (readButton) {
                event.preventDefault();
                const sectionId = readButton.closest('.section').id;
                toggleReading(sectionId, readButton);
            } else {
                handleWordClick(event);
            }
        }

        function toggleTranslation(element) {
            const translation = element.getAttribute('data-translation');
            if (translation) {
                const translationElement = element.querySelector('.translation');
                if (translationElement) {
                    translationElement.remove();
                } else {
                    const span = document.createElement('span');
                    span.className = 'translation';
                    span.textContent = translation;
                    element.appendChild(span);
                }
            }
        }

        // Add this function to save highlighted word data
        function saveHighlightedWordData(sectionId) {
            console.log(`Saving highlightedWordData for section ${sectionId}`);
            const section = document.getElementById(sectionId);
            const words = section.querySelectorAll('.chinese-word');
            const highlightedWordData = Array.from(words).map(word => ({
                word: word.getAttribute('data-word'),
                highlighted: word.classList.contains('highlighted')
            }));

            localStorage.setItem(`highlightedWordData_${sectionId}`, JSON.stringify(highlightedWordData));
            console.log(`Saved highlightedWordData for section ${sectionId}:`, JSON.stringify(highlightedWordData));
        }

        // Modify the toggleLock function
        function toggleLock(sectionId, button) {
            console.log(`Toggling lock for section ${sectionId}`);
            testLocalStorage();  // Add this line
            
            const section = document.getElementById(sectionId);
            const isLocked = button.classList.toggle('locked');
            button.textContent = isLocked ? 'Unlock' : 'Lock';

            // Save the lock state
            localStorage.setItem(`lockState_${sectionId}`, isLocked);
            
            // Log the current highlightedWordData
            const currentData = localStorage.getItem(`highlightedWordData_${sectionId}`);
            console.log(`Current highlightedWordData for section ${sectionId}:`, currentData);

            if (isLocked) {
                console.log(`Section ${sectionId} is now locked`);
                // Show highlights based on existing data
                const highlightedWordData = JSON.parse(currentData) || [];
                console.log(`Parsed highlightedWordData:`, highlightedWordData);
                highlightedWordData.forEach(data => {
                    const word = section.querySelector(`.chinese-word[data-word="${data.word}"]`);
                    if (word && data.highlighted) {
                        word.classList.add('highlighted');
                        console.log(`Highlighted word: ${data.word}`);
                    }
                });
            } else {
                console.log(`Section ${sectionId} is now unlocked`);
                // Hide highlights visually, but don't clear the data
                clearVisibleHighlights(sectionId);
            }
            
            // Update the saved section if it exists
            updateSavedSection(sectionId);

            // Log the highlightedWordData after toggle
            const afterToggleData = localStorage.getItem(`highlightedWordData_${sectionId}`);
            console.log(`highlightedWordData after toggle for section ${sectionId}:`, afterToggleData);
        }

        // Add a function to clear highlights visually without clearing the data
        function clearVisibleHighlights(sectionId) {
            const section = document.getElementById(sectionId);
            section.querySelectorAll('.chinese-word.highlighted').forEach(word => {
                word.classList.remove('highlighted');
            });
        }

        // Modify the loadWordStates function to respect the lock state for visibility
        function loadWordStates() {
            document.querySelectorAll('.section').forEach(section => {
                const sectionId = section.id;
                const highlightedWordData = JSON.parse(localStorage.getItem(`highlightedWordData_${sectionId}`)) || [];
                const isLocked = JSON.parse(localStorage.getItem(`lockState_${sectionId}`)) || false;

                const lockButton = section.querySelector('.lock-button');
                if (lockButton) {
                    lockButton.classList.toggle('locked', isLocked);
                    lockButton.textContent = isLocked ? 'Unlock' : 'Lock';
                }

                if (isLocked) {
                    highlightedWordData.forEach(data => {
                        const word = section.querySelector(`.chinese-word[data-word="${data.word}"]`);
                        if (word && data.highlighted) {
                            word.classList.add('highlighted');
                        }
                    });
                } else {
                    clearVisibleHighlights(sectionId);
                }
            });
        }

        // Add this function
        function updateSavedSection(sectionId) {
            console.log(`Updating saved section ${sectionId}`);
            let savedSection = document.getElementById(`saved-${sectionId}`);
            const originalSection = document.getElementById(sectionId);
            const content = originalSection.querySelector('.content').innerHTML;
            const highlightedWordData = JSON.parse(localStorage.getItem(`highlightedWordData_${sectionId}`)) || [];
            
            console.log(`highlightedWordData for updating saved section ${sectionId}:`, JSON.stringify(highlightedWordData));
            
            if (!savedSection) {
                savedSection = document.createElement('div');
                savedSection.id = `saved-${sectionId}`;
                savedSection.className = 'section';
                document.getElementById('saved-blocks').appendChild(savedSection);
            }
            
            const title = originalSection.querySelector('h2').innerHTML;
            
            const clozedContent = applyClozeDeletetion(title + content, highlightedWordData);
            console.log(`Clozed content for section ${sectionId}:`, clozedContent);
            
            savedSection.innerHTML = `
                <div class="section-content">
                    <div class="content-block">
                        ${clozedContent}
                    </div>
                </div>
                <div class="button-container">
                    <button class="read-button" onclick="toggleReading('saved-${sectionId}', this)">Read</button>
                    <button class="show-button" onclick="toggleClozeVisibility('saved-${sectionId}')">Show</button>
                    <button class="save-button saved" onclick="toggleSaveSection('${sectionId}')">Unsave</button>
                </div>
            `;
            
            console.log(`Updated saved section ${sectionId} HTML:`, savedSection.innerHTML);
        }

        function checkHighlightedWordData(sectionId) {
            const data = localStorage.getItem(`highlightedWordData_${sectionId}`);
            console.log(`Current highlightedWordData for section ${sectionId}:`, data);
            return data;
        }

        function testLocalStorage() {
            console.log("Testing localStorage...");
            localStorage.setItem('test', 'Hello, World!');
            const testValue = localStorage.getItem('test');
            console.log("Test value from localStorage:", testValue);
            localStorage.removeItem('test');
        }

        function testFunction() {
            console.log('Test function executed');
        }

        testFunction();

        function applyClozeDeletetion(content, highlightedWordData) {
            console.log('Applying cloze deletion with data:', highlightedWordData);
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            
            highlightedWordData.forEach(data => {
                if (data.highlighted) {
                    const words = doc.querySelectorAll(`.chinese-word[data-word="${data.word}"]`);
                    words.forEach(word => {
                        console.log(`Applying cloze to word: ${data.word}`);
                        const cloze = document.createElement('span');
                        cloze.className = 'cloze';
                        cloze.textContent = '[...]';
                        const answer = document.createElement('span');
                        answer.className = 'cloze-answer';
                        answer.style.display = 'none';
                        answer.innerHTML = word.innerHTML;
                        word.innerHTML = '';
                        word.appendChild(cloze);
                        word.appendChild(answer);
                        word.classList.add('cloze-container');
                    });
                }
            });
            
            const result = doc.body.innerHTML;
            console.log('Cloze deletion result:', result);
            return result;
        }

        function toggleClozeVisibility(sectionId) {
            console.log(`Toggling cloze visibility for section ${sectionId}`);
            const section = document.getElementById(sectionId);
            const clozeContainers = section.querySelectorAll('.cloze-container');
            const showButton = section.querySelector('.show-button');

            console.log(`Found ${clozeContainers.length} cloze containers`);

            clozeContainers.forEach(container => {
                const cloze = container.querySelector('.cloze');
                const answer = container.querySelector('.cloze-answer');
                if (cloze && answer) {
                    cloze.style.display = cloze.style.display === 'none' ? 'inline' : 'none';
                    answer.style.display = answer.style.display === 'none' ? 'inline' : 'none';
                    console.log(`Toggled visibility for word: ${container.getAttribute('data-word')}`);
                }
            });

            showButton.textContent = showButton.textContent === 'Show' ? 'Hide' : 'Show';
            console.log(`Cloze visibility toggled for section ${sectionId}`);
        }
    </script>
</body>
</html>